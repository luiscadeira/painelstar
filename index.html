<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>STAR STUDIO CAR - BUSINESS</title>
    <style>
        :root {
            --primary: #25D366;
            --primary-dark: #128C7E;
            --bg: #0a0a0a;
            --card-bg: #1e1e1e;
            --input-bg: #2d2d2d;
            --text-main: #ffffff;
            --text-sub: #b3b3b3;
            --danger: #ff4757;
            --accent: #3d5afe;
            --radius: 14px;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            --amber: #f59e0b;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Inter', sans-serif;
        }

        body {
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            position: relative;
        }

        .bg,
        .overlay-b,
        .overlay-tr,
        .grid {
            position: fixed;
            inset: 0;
            z-index: 0;
        }

        .bg {
            background-position: center;
            background-size: cover;
            transition: opacity .6s, transform .6s;
        }

        .overlay-b {
            background-image: linear-gradient(to bottom, rgba(0, 0, 0, .75), rgba(0, 0, 0, .65), rgba(0, 0, 0, .85));
        }

        .overlay-tr {
            background-image: linear-gradient(to top right, rgba(245, 158, 11, .25), transparent, rgba(234, 179, 8, .2));
        }

        .grid {
            opacity: .06;
            background-image:
                linear-gradient(rgba(255, 255, 255, .08) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, .08) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none;
        }

        .nav-tabs {
            display: flex;
            background: rgba(0, 0, 0, .35);
            padding: 8px;
            gap: 5px;
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, .08);
            position: sticky;
            top: 0;
            /* host for moving highlight */
            position: sticky;
        }

        .nav-tabs {
            position: sticky;
        }

        .nav-tabs::after {
            content: "";
        }

        .tab-highlight {
            position: absolute;
            top: 8px;
            left: 0;
            height: 40px;
            border-radius: 12px;
            background: linear-gradient(90deg, #f59e0b, #eab308);
            box-shadow: 0 8px 24px rgba(245, 158, 11, .35);
            transition: transform .35s ease, width .35s ease, opacity .2s;
            opacity: .95;
            z-index: 1;
        }

        .tab-btn {
            flex: 1;
            padding: 12px 5px;
            border: none;
            background: transparent;
            color: var(--text-sub);
            font-weight: 700;
            font-size: 0.7rem;
            border-radius: 10px;
            transition: 0.3s;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            z-index: 2;
            /* above highlight */
        }

        .tab-btn.active {
            background: linear-gradient(135deg, rgba(245, 158, 11, .25), rgba(234, 179, 8, .2));
            color: #fff;
            box-shadow: 0 4px 24px rgba(245, 158, 11, .35);
        }

        .tab-btn.active::before {
            content: "";
            position: absolute;
            inset: 0;
            border-radius: 10px;
            background: linear-gradient(90deg, rgba(245, 158, 11, .6), rgba(234, 179, 8, .6));
            opacity: .25;
            filter: blur(8px);
        }

        .tab-content {
            display: none;
            opacity: 0;
            transform: translateX(12px);
            transition: opacity .3s ease, transform .3s ease;
        }

        .tab-content.active {
            display: block;
            opacity: 1;
            transform: translateX(0);

            .tab-content.fade-in,
            .tab-content.fade-out {
                display: block;
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateX(12px);
                }

                to {
                    opacity: 1;
                    transform: translateX(0);
                }
            }

            @keyframes fadeOut {
                from {
                    opacity: 1;
                    transform: translateX(0);
                }

                to {
                    opacity: 0;
                    transform: translateX(-12px);
                }
            }

            .fade-in {
                animation: fadeIn .35s ease both;
            }

            .fade-out {
                animation: fadeOut .25s ease both;
            }

            .container {
                width: 100%;
                max-width: 500px;
                margin: 0 auto;
                padding: 15px;
                padding-bottom: 120px;
                position: relative;
                z-index: 10;
            }

            header {
                text-align: center;
                margin: 20px 0;
            }

            header h1 {
                font-size: 2rem;
                margin: 0;
                font-weight: 900;
                background: linear-gradient(90deg, #f59e0b, #eab308);
                -webkit-background-clip: text;
                background-clip: text;
                color: transparent;
                text-shadow: 0 0 20px rgba(245, 158, 11, .5);
                animation: glow 3s infinite;
            }

            header span {
                font-size: 0.7rem;
                color: #f5d47a;
                text-transform: uppercase;
                letter-spacing: 2px;
                font-weight: 900;
                display: inline-block;
                padding: 8px 16px;
                border-radius: 999px;
                background: linear-gradient(135deg, rgba(245, 158, 11, .2), rgba(234, 179, 8, .2));
                border: 1px solid rgba(245, 158, 11, .35);
                box-shadow: 0 0 30px rgba(245, 158, 11, .35);
                animation: badgeGlow 2s infinite;
            }

            .card {
                border-radius: var(--radius);
                padding: 18px;
                margin-bottom: 15px;
                border: 1px solid rgba(255, 255, 255, .08);
                box-shadow: 0 12px 32px rgba(0, 0, 0, .35);
                backdrop-filter: blur(12px) saturate(120%);
                background:
                    linear-gradient(135deg, rgba(245, 158, 11, .06), rgba(234, 179, 8, .03)),
                    linear-gradient(180deg, rgba(18, 18, 18, .65), rgba(18, 18, 18, .45));
            }

            .section-title {
                font-size: 0.75rem;
                font-weight: 800;
                margin-bottom: 12px;
                color: var(--text-sub);
                text-transform: uppercase;
                display: flex;
                align-items: center;
                gap: 8px;
            }

            @keyframes glow {

                0%,
                100% {
                    text-shadow: 0 0 20px rgba(245, 158, 11, .5);
                }

                50% {
                    text-shadow: 0 0 40px rgba(245, 158, 11, .8);
                }
            }

            @keyframes badgeGlow {

                0%,
                100% {
                    box-shadow: 0 0 20px rgba(245, 158, 11, .3);
                }

                50% {
                    box-shadow: 0 0 40px rgba(245, 158, 11, .5);
                }
            }

            input,
            select,
            textarea {
                width: 100%;
                border: 1px solid rgba(255, 255, 255, .08);
                border-radius: 14px;
                padding: 12px 14px;
                font-size: 0.95rem;
                background:
                    linear-gradient(135deg, rgba(255, 255, 255, .06), rgba(255, 255, 255, .03)),
                    rgba(24, 24, 24, .55);
                color: white;
                margin-bottom: 10px;
                backdrop-filter: blur(10px) saturate(120%);
                box-shadow: inset 0 1px 4px rgba(255, 255, 255, .06);
            }

            input::placeholder,
            textarea::placeholder {
                color: rgba(255, 255, 255, .45);
            }

            input:focus,
            select:focus,
            textarea:focus {
                outline: none;
                border-color: rgba(245, 158, 11, .45);
                box-shadow: 0 0 0 2px rgba(245, 158, 11, .25);
            }

            .day-row {
                display: flex;
                justify-content: space-between;
                padding: 10px 0;
                border-bottom: 1px solid #333;
                align-items: center;
            }

            .inspection-grid,
            .services-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }

            .inspect-item {
                background: #252525;
                padding: 10px;
                border-radius: 8px;
                font-size: 0.75rem;
                display: flex;
                align-items: center;
                gap: 8px;
                border: 1px solid transparent;
                cursor: pointer;
                font-weight: 600;
            }

            .service-item {
                background: #181818;
                padding: 15px;
                border-radius: 12px;
                display: flex;
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
                border: 1px solid #333;
                cursor: pointer;
                transition: all 0.2s ease;
                position: relative;
            }

            .service-item:hover {
                border-color: #555;
            }

            .inspect-item:has(input:checked) {
                border-color: var(--danger);
                color: var(--danger);
                background: rgba(255, 71, 87, 0.1);
            }

            .service-item input,
            .inspect-item input {
                display: none;
            }

            .service-item:has(input:checked) {
                border-color: var(--primary);
                background: #0b1a10;
                box-shadow: 0 0 0 1px var(--primary);
            }

            .service-item:has(input:checked) .svc-title {
                color: var(--primary);
            }

            .service-item:has(input:checked) .svc-price {
                color: var(--primary);
            }

            .service-item:has(input:checked)::after {
                content: '‚úì';
                position: absolute;
                top: 10px;
                right: 10px;
                background: var(--primary);
                color: black;
                width: 20px;
                height: 20px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 12px;
                font-weight: 900;
            }

            .svc-icon {
                font-size: 1.4rem;
                margin-bottom: 5px;
                color: #ccc;
            }

            .svc-info {
                display: flex;
                flex-direction: column;
            }

            .svc-title {
                font-size: 0.75rem;
                color: #b3b3b3;
                font-weight: 500;
                margin-bottom: 4px;
            }

            .svc-price {
                font-size: 0.95rem;
                color: white;
                font-weight: 700;
            }

            .total-display {
                font-size: 1.1rem;
                font-weight: 900;
                text-align: center;
                color: var(--primary);
                background: #0b1a10;
                padding: 20px;
                border-radius: 12px;
                margin-bottom: 15px;
                border: 1px solid #1f3a28;
                display: flex;
                flex-direction: column;
                gap: 5px;
            }

            .total-label {
                font-size: 0.7rem;
                color: #4cd137;
                text-transform: uppercase;
                letter-spacing: 1px;
                opacity: 0.8;
            }

            .total-value {
                font-size: 1.8rem;
                color: #25D366;
                text-shadow: 0 0 10px rgba(37, 211, 102, 0.2);
            }

            .btn {
                border: none;
                border-radius: 12px;
                padding: 14px;
                font-size: 0.8rem;
                font-weight: 800;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
                flex: 1;
                transition: all 0.2s;
            }

            .btn:active {
                transform: scale(0.98);
                opacity: 0.9;
            }

            .btn-copy {
                background: #333;
                color: white;
                border: 1px solid #444;
            }

            .btn-ready {
                background: #3e2e0e;
                color: #ffc107;
                margin-bottom: 15px;
                width: 100%;
                border: 1px solid #664d03;
                padding: 16px;
                font-size: 0.85rem;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            }

            .btn-ready:hover {
                background: #4a3812;
                box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
            }

            .fixed-action {
                position: fixed;
                bottom: 20px;
                right: 20px;
                left: 20px;
                z-index: 2000;
                max-width: 460px;
                margin: 0 auto;
            }

            .btn-whatsapp {
                background: var(--primary);
                color: white;
                padding: 16px;
                border-radius: 50px;
                font-size: 0.9rem;
                font-weight: 800;
                box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
                width: 100%;
                border: none;
                cursor: pointer;
            }

            #toast {
                position: fixed;
                bottom: 100px;
                left: 50%;
                transform: translateX(-50%);
                background: white;
                color: black;
                padding: 8px 20px;
                border-radius: 20px;
                font-size: 0.75rem;
                font-weight: 700;
                display: none;
                z-index: 3000;
            }

            .history-item {
                background: #252525;
                padding: 12px;
                border-radius: 10px;
                margin-bottom: 10px;
                border-left: 4px solid var(--primary);
                font-size: 0.8rem;
            }

            textarea {
                resize: none;
                height: 120px;
            }

            .tab-content.fade-in,
            .tab-content.fade-out {
                display: block;
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateX(12px);
                }

                to {
                    opacity: 1;
                    transform: translateX(0);
                }
            }

            @keyframes fadeOut {
                from {
                    opacity: 1;
                    transform: translateX(0);
                }

                to {
                    opacity: 0;
                    transform: translateX(-12px);
                }
            }

            .day-row {
                gap: 8px;
                flex-wrap: wrap;
            }

            .day-row select {
                min-width: 120px;
            }

            .card {
                -webkit-backdrop-filter: blur(12px) saturate(120%);
            }

            input,
            select,
            textarea {
                -webkit-backdrop-filter: blur(10px) saturate(120%);
            }

            @media (max-width: 380px) {
                .container {
                    padding: 12px;
                    max-width: 480px;
                }

                .nav-tabs {
                    padding: 6px;
                    gap: 6px;
                }

                .tab-btn {
                    padding: 10px 6px;
                    font-size: 0.65rem;
                }

                header h1 {
                    font-size: 1.6rem;
                }

                .services-grid {
                    grid-template-columns: 1fr;
                }

                .inspection-grid {
                    grid-template-columns: 1fr;
                }

                input,
                select,
                textarea {
                    font-size: 0.9rem;
                    padding: 12px;
                }

                .fixed-action {
                    bottom: 12px;
                    left: 12px;
                    right: 12px;
                    max-width: 480px;
                }

                .btn {
                    padding: 12px;
                    font-size: 0.75rem;
                }

                .tab-highlight {
                    height: 36px;
                    top: 6px;
                }
            }

            @media (min-width: 640px) {
                header h1 {
                    font-size: 2.2rem;
                }

                .container {
                    max-width: 560px;
                }

                .tab-btn {
                    font-size: 0.75rem;
                }
            }
    </style>
</head>

<body>

    <div id="toast">Copiado!</div>
    <div class="bg"></div>
    <div class="overlay-b"></div>
    <div class="overlay-tr"></div>
    <div class="grid"></div>

    <nav class="nav-tabs">
        <div class="tab-highlight"></div>
        <button class="tab-btn active" onclick="openTab('semanal', this)">üìÖ AGENDA</button>
        <button class="tab-btn" onclick="openTab('individual', this)">üõ† NOVO SERVI√áO</button>
        <button class="tab-btn" onclick="openTab('historico', this)">üóÇ HIST√ìRICO</button>
    </nav>

    <div class="container">
        <header>
            <img src="logo.png" alt="Logo STAR STUDIO CAR"
                style="height:56px; border-radius:8px; display:block; margin:0 auto 8px; filter: drop-shadow(0 0 20px rgba(245, 158, 11, .6)); animation: logoPulse 2s infinite;">
            <h1>STAR STUDIO CAR</h1>
            <span>Est√©tica Automotiva</span>
        </header>

        <!-- ABA 1: AGENDA -->
        <div id="semanal" class="tab-content active">
            <div class="card">
                <div class="section-title">üìÖ Per√≠odo da Semana</div>
                <input type="date" id="mondayDate" onchange="atualizarSemana()">
                <div id="dayGrid"></div>
                <button class="btn"
                    style="background:#ff4757; color:white; margin-top:10px; font-size:0.7rem; padding:8px; width:100%"
                    onclick="resetarAgendaParaAberta()">üîÑ Resetar Toda Semana</button>
            </div>
            <div class="card">
                <textarea id="outputSemanal" readonly></textarea>
                <div style="display:flex; gap:10px">
                    <button class="btn btn-copy" onclick="copiar('outputSemanal')">üìã Copiar Lista</button>
                    <button class="btn" style="background:var(--accent); color:white" onclick="copiarStatusSemanal()">üìÖ
                        Status</button>
                </div>
            </div>
        </div>

        <!-- ABA 2: NOVO SERVI√áO -->
        <div id="individual" class="tab-content">
            <div class="card">
                <div class="section-title">üë§ Cliente & Ve√≠culo</div>
                <input type="text" id="clientName" placeholder="CLIENTE" oninput="gerarMensagemIndividual()">

                <input type="text" id="carInfo" placeholder="VEICULO" oninput="buscarHistorico(this.value)">
                <div style="display:flex; gap:10px">
                    <input type="date" id="serviceDate" onchange="gerarMensagemIndividual()">
                    <input type="time" id="serviceTime" onchange="gerarMensagemIndividual()">
                </div>
            </div>

            <div class="card">
                <div class="section-title">üõ† Servi√ßos</div>
                <div class="services-grid">
                    <label class="service-item">
                        <input type="checkbox" class="svc" data-price="60" value="Lavagem Comercial"
                            onchange="gerarMensagemIndividual()">
                        <div class="svc-icon">üßº</div>
                        <div class="svc-info">
                            <span class="svc-title">Lavagem Comercial</span>
                            <span class="svc-price">R$ 60,00</span>
                        </div>
                    </label>
                    <label class="service-item">
                        <input type="checkbox" class="svc" data-price="185" value="Lavagem Detalhada"
                            onchange="gerarMensagemIndividual()">
                        <div class="svc-icon">‚ú®</div>
                        <div class="svc-info">
                            <span class="svc-title">Lavagem Detalhada</span>
                            <span class="svc-price">R$ 185,00</span>
                        </div>
                    </label>
                    <label class="service-item">
                        <input type="checkbox" class="svc" data-price="185" value="Higieniza√ß√£o de Banco"
                            onchange="gerarMensagemIndividual()">
                        <div class="svc-icon">ü™ë</div>
                        <div class="svc-info">
                            <span class="svc-title">Higieniza√ß√£o de Banco</span>
                            <span class="svc-price">R$ 185,00</span>
                        </div>
                    </label>
                    <label class="service-item">
                        <input type="checkbox" class="svc" data-price="285" value="Higieniza√ß√£o Completa"
                            onchange="gerarMensagemIndividual()">
                        <div class="svc-icon">üßΩ</div>
                        <div class="svc-info">
                            <span class="svc-title">Higieniza√ß√£o Completa</span>
                            <span class="svc-price">R$ 285,00</span>
                        </div>
                    </label>
                    <label class="service-item">
                        <input type="checkbox" class="svc" data-price="385" value="Polimento c/ Enceramento"
                            onchange="gerarMensagemIndividual()">
                        <div class="svc-icon">üíé</div>
                        <div class="svc-info">
                            <span class="svc-title">Polimento c/ Enceramento</span>
                            <span class="svc-price">R$ 385,00</span>
                        </div>
                    </label>
                    <label class="service-item">
                        <input type="checkbox" class="svc" data-price="585" value="Higieniza√ß√£o + Polimento"
                            onchange="gerarMensagemIndividual()">
                        <div class="svc-icon">üèÜ</div>
                        <div class="svc-info">
                            <span class="svc-title">Higieniza√ß√£o + Polimento</span>
                            <span class="svc-price">R$ 585,00</span>
                        </div>
                    </label>
                </div>
            </div>

            <div class="card">
                <div class="section-title">‚ö†Ô∏è Vistoria & Entrega</div>
                <div class="inspection-grid" style="margin-bottom: 15px;">
                    <label class="inspect-item"><input type="checkbox" class="insp" value="Riscos na pintura"
                            onchange="gerarMensagemIndividual()"> ‚ú¥Ô∏è Riscos</label>
                    <label class="inspect-item"><input type="checkbox" class="insp" value="Amassados"
                            onchange="gerarMensagemIndividual()"> üõ†Ô∏è Amassados</label>
                    <label class="inspect-item"><input type="checkbox" class="insp" value="Rodas raladas"
                            onchange="gerarMensagemIndividual()"> üõû Rodas</label>
                    <label class="inspect-item"><input type="checkbox" class="insp" value="Vidro trincado"
                            onchange="gerarMensagemIndividual()"> ü™ü Vidro</label>
                </div>
                <input type="text" id="linkFotos" placeholder="Link das Fotos (Opcional)"
                    oninput="gerarMensagemIndividual()">
            </div>

            <div class="card">
                <div id="totalDisplay" class="total-display">
                    <span class="total-label">Total</span>
                    <span class="total-value" id="totalValue">R$ 0,00</span>
                </div>
                <button class="btn btn-ready" onclick="gerarMensagemPronto()">‚ú® GERAR AVISO DE PRONTO</button>
                <textarea id="outputIndividual" readonly></textarea>
                <div style="display:flex; gap:10px">
                    <button class="btn btn-copy" onclick="baixarICS()">üìÖ ICS</button>
                    <button class="btn btn-copy" onclick="copiarIndividual()">üìã Copiar</button>
                    <button class="btn" style="background:var(--accent); color:white" onclick="limparCampos()">üîÑ
                        Limpar</button>
                </div>
            </div>
        </div>

        <!-- ABA 3: HIST√ìRICO -->
        <div id="historico" class="tab-content">
            <div class="card">
                <div class="section-title">üìã √öltimos Servi√ßos Salvos</div>
                <div id="listaHistorico"></div>
                <button class="btn" style="background:#333; color:white; width:100%; margin-top:20px"
                    onclick="limparHistoricoTotal()">Apagar Hist√≥rico</button>
            </div>
        </div>
    </div>

    <div class="fixed-action">
        <button class="btn btn-whatsapp" onclick="enviarWhatsApp()">üì≤ ENVIAR PARA WHATSAPP</button>
    </div>

    <script>
        const MAP_LINK = "https://maps.app.goo.gl/KPY28spUTp2C3Xp58";
        const dias = ['Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado', 'Domingo'];
        const fmtBRL = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
        const backgrounds = {
            semanal: "https://images.unsplash.com/photo-1619642751034-765dfdf7c58e?w=1920&q=70&fm=webp",
            individual: "https://images.unsplash.com/photo-1607860108855-64acf2078ed9?w=1920&q=70&fm=webp",
            historico: "https://images.unsplash.com/photo-1486262715619-67b85e0b08d3?w=1920&q=70&fm=webp"
        };
        function setBackground(id) {
            const el = document.querySelector('.bg');
            if (el) el.style.backgroundImage = `url(${backgrounds[id]})`;
        }
        function updateHighlight(btn) {
            const nav = document.querySelector('.nav-tabs');
            const hl = document.querySelector('.tab-highlight');
            if (!nav || !hl || !btn) return;
            const r = btn.getBoundingClientRect();
            const nv = nav.getBoundingClientRect();
            const left = r.left - nv.left;
            hl.style.transform = `translateX(${left}px)`;
            hl.style.width = `${r.width}px`;
        }

        function openTab(id, btn) {
            const prev = document.querySelector('.tab-content.active');
            if (prev) {
                prev.classList.remove('active');
                prev.classList.add('fade-out');
                setTimeout(() => prev.classList.remove('fade-out'), 250);
            }
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('fade-in'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.getElementById(id).classList.add('fade-in');
            if (btn) btn.classList.add('active');
            if (id === 'historico') carregarAbaHistorico();
            setBackground(id);
            if (btn) updateHighlight(btn);
        }

        // --- INICIALIZA√á√ÉO E PERSIST√äNCIA DA AGENDA ---
        function initApp() {
            const grid = document.getElementById('dayGrid');
            if (grid) {
                grid.innerHTML = dias.map((dia, i) => `
                    <div class="day-row">
                        <div><div style="font-size:0.6rem; color:var(--text-sub)" id="date-${i}">--/--</div><strong>${dia}</strong></div>
                        <select id="status-${i}" onchange="salvarAgendaManual()" style="width:130px; padding:5px; background:#2d2d2d; color:white; border-radius:5px; border:1px solid #444">
                            <option value="Aberta ‚úÖ">Aberta ‚úÖ</option>
                            <option value="*Reservado* ‚ùå">Reservado ‚ùå</option>
                            <option value="*A confirmar* ‚è≥">Confirmar ‚è≥</option>
                        </select>
                    </div>`).join('');
            }
            carregarAgendaSalva();

            // Set default date to today for service
            const today = new Date().toISOString().split('T')[0];
            if (document.getElementById('serviceDate')) document.getElementById('serviceDate').value = today;
            setBackground('semanal');
            const activeBtn = document.querySelector('.tab-btn.active');
            updateHighlight(activeBtn);
            window.addEventListener('resize', () => updateHighlight(document.querySelector('.tab-btn.active')));
        }

        const styleAnim = document.createElement('style');
        styleAnim.innerHTML = `
        @keyframes logoPulse {
          0% { filter: drop-shadow(0 0 20px rgba(245, 158, 11, .6)); }
          50% { filter: drop-shadow(0 0 40px rgba(245, 158, 11, .8)); }
          100% { filter: drop-shadow(0 0 20px rgba(245, 158, 11, .6)); }
        }`;
        document.head.appendChild(styleAnim);

        function salvarAgendaManual() {
            const dadosAgenda = [];
            for (let i = 0; i < 7; i++) {
                const el = document.getElementById(`status-${i}`);
                if (el) dadosAgenda.push(el.value);
            }
            localStorage.setItem('star_agenda_status', JSON.stringify(dadosAgenda));
            localStorage.setItem('star_agenda_data', document.getElementById('mondayDate').value);
            atualizarSemana();
        }

        function carregarAgendaSalva() {
            const dataSalva = localStorage.getItem('star_agenda_data');
            const statusSalvo = JSON.parse(localStorage.getItem('star_agenda_status'));

            if (dataSalva) {
                const dateEl = document.getElementById('mondayDate');
                if (dateEl) dateEl.value = dataSalva;
            } else {
                setProximaSegunda();
            }

            if (statusSalvo) {
                statusSalvo.forEach((status, i) => {
                    const el = document.getElementById(`status-${i}`);
                    if (el) el.value = status;
                });
            } else {
                // Default reset if no saved status but we might have reset logic
            }
            atualizarSemana();
        }

        function resetarAgendaParaAberta() {
            if (confirm("Deseja abrir todos os hor√°rios da semana?")) {
                for (let i = 0; i < 7; i++) {
                    const el = document.getElementById(`status-${i}`);
                    if (el) el.value = "Aberta ‚úÖ";
                }
                salvarAgendaManual();
            }
        }

        function setProximaSegunda() {
            const d = new Date();
            const day = d.getDay();
            const diff = d.getDate() - day + (day == 0 ? -6 : 1); // adjust when day is sunday
            const monday = new Date(d.setDate(diff));
            const dateEl = document.getElementById('mondayDate');
            if (dateEl) dateEl.value = monday.toISOString().split('T')[0];
        }

        function atualizarSemana() {
            const dateEl = document.getElementById('mondayDate');
            if (!dateEl || !dateEl.value) return;

            const dataInput = dateEl.value;
            let base = new Date(dataInput + 'T12:00:00');
            let textoSemana = "";
            dias.forEach((dia, i) => {
                const d = new Date(base); d.setDate(base.getDate() + i);
                const dataF = String(d.getDate()).padStart(2, '0') + '/' + String(d.getMonth() + 1).padStart(2, '0');
                const labelData = document.getElementById(`date-${i}`);
                if (labelData) labelData.innerText = dataF;

                const statusEl = document.getElementById(`status-${i}`);
                if (statusEl) textoSemana += `üìù *${dia} (${dataF})* ‚Äì ${statusEl.value}\n`;
            });
            const out = document.getElementById('outputSemanal');
            if (out) out.value = `üì¢ *AGENDA DA SEMANA*\n\nOl√°! üëã Hor√°rios dispon√≠veis:\n\n${textoSemana}\n*STAR STUDIO CAR* üöó‚ú®`;
        }

        // --- GERA√á√ÉO DE MENSAGENS ---
        function gerarMensagemIndividual() {
            const nome = document.getElementById('clientName').value || "Cliente";
            const carro = document.getElementById('carInfo').value || "Ve√≠culo";
            const dataRaw = document.getElementById('serviceDate').value;
            const hora = document.getElementById('serviceTime').value || "00:00";
            let dataF = dataRaw ? new Date(dataRaw + 'T12:00:00').toLocaleDateString('pt-BR') : "--/--/--";

            let total = 0;
            const selecionados = Array.from(document.querySelectorAll('.svc:checked')).map(c => {
                total += parseFloat(c.dataset.price);
                return `‚Ä¢ ${c.value}`;
            });

            const danos = Array.from(document.querySelectorAll('.insp:checked')).map(c => c.value);
            document.getElementById('totalValue').innerText = fmtBRL.format(total);

            let texto = `Ol√°, *${nome}*! üëã\n\nConfirmamos seu agendamento na *STAR STUDIO CAR* ‚úÖ\n\nüöó *Ve√≠culo/Placa:* ${carro}\nüóì *Data:* ${dataF}\n‚è∞ *Hor√°rio:* ${hora}\n\nüõ† *Servi√ßos:*\n${selecionados.join('\n') || '‚Ä¢ A definir'}\n\nüí∞ *Valor:* ${fmtBRL.format(total)}\n`;
            if (danos.length > 0) texto += `\n‚ö†Ô∏è *VISTORIA:* ${danos.join(', ')}.\n`;
            texto += `\nüìç *Localiza√ß√£o:* ${MAP_LINK}\n\nLuis ‚Äì *STAR STUDIO CAR* üöó‚ú®`;

            const out = document.getElementById('outputIndividual');
            if (out) out.value = texto;
        }

        function gerarMensagemPronto() {
            const nome = document.getElementById('clientName').value || "Cliente";
            const carro = document.getElementById('carInfo').value || "Ve√≠culo";
            const link = document.getElementById('linkFotos').value;
            const total = document.getElementById('totalValue').innerText;

            let texto = `Seu carro est√° pronto, *${nome}*! ‚ú®üöó\n\nFinalizamos os servi√ßos no seu *${carro}*!\n\n${link ? `üì∏ *Veja as fotos do servi√ßo:* ${link}\n` : ''}\nüí∞ *${total}*\n\nO ve√≠culo j√° est√° dispon√≠vel para retirada.üåü\n\nüìç *Localiza√ß√£o:* ${MAP_LINK}\n\nLuis ‚Äì *STAR STUDIO CAR* üöó‚ú®`;
            document.getElementById('outputIndividual').value = texto;
            showToast("Mensagem de PRONTO gerada!");
        }

        // --- SISTEMA DE HIST√ìRICO ---
        function salvarNoHistorico() {
            const placa = document.getElementById('carInfo').value.toUpperCase();
            const nome = document.getElementById('clientName').value;
            const total = document.getElementById('totalDisplay').innerText;
            if (!placa || !nome) return;
            let historico = JSON.parse(localStorage.getItem('star_history') || '[]');
            historico.unshift({ placa, nome, total, data: new Date().toLocaleDateString('pt-BR') });
            localStorage.setItem('star_history', JSON.stringify(historico.slice(0, 50)));
        }

        function buscarHistorico(placa) {
            gerarMensagemIndividual();
            if (placa.length < 3) return;
            const historico = JSON.parse(localStorage.getItem('star_history') || '[]');
            const clienteFiel = historico.find(h => h.placa.includes(placa.toUpperCase()));
            if (clienteFiel) document.getElementById('clientName').value = clienteFiel.nome;
        }

        function carregarAbaHistorico() {
            const lista = document.getElementById('listaHistorico');
            const historico = JSON.parse(localStorage.getItem('star_history') || '[]');
            lista.innerHTML = historico.map(h => `
            <div class="history-item">
                <small>${h.data}</small><br>
                <strong>${h.placa}</strong> - ${h.nome} | <span style="color:var(--primary)">${h.total}</span>
            </div>`).join('') || '<p style="text-align:center; color:gray">Sem hist√≥rico.</p>';
        }

        function limparHistoricoTotal() {
            if (confirm("Apagar todo o hist√≥rico de atendimentos?")) {
                localStorage.removeItem('star_history');
                carregarAbaHistorico();
            }
        }

        // --- AUXILIARES ---
        async function copiar(id) {
            const el = document.getElementById(id);
            const txt = el.tagName === 'TEXTAREA' || el.tagName === 'INPUT' ? el.value : el.innerText;
            try {
                await navigator.clipboard.writeText(txt);
                showToast("Copiado!");
            } catch (e) {
                // Fallback
                const temp = document.createElement('textarea');
                temp.value = txt;
                document.body.appendChild(temp);
                temp.select();
                document.execCommand('copy');
                document.body.removeChild(temp);
                showToast("Copiado!");
            }
        }

        function copiarIndividual() {
            copiar('outputIndividual');
            salvarNoHistorico();
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 2000);
        }

        function limparCampos() {
            document.getElementById('clientName').value = "";
            document.getElementById('clientPhone').value = "";
            document.getElementById('carInfo').value = "";
            document.getElementById('linkFotos').value = "";
            document.querySelectorAll('.svc, .insp').forEach(c => c.checked = false);
            gerarMensagemIndividual();
        }

        function copiarStatusSemanal() {
            copiar('outputSemanal');
            showToast("Lista da semana copiada!");
        }

        function enviarWhatsApp() {
            const tab = document.querySelector('.tab-btn.active').innerText;
            let id = tab.includes("AGENDA") ? 'outputSemanal' : 'outputIndividual';
            if (tab.includes("NOVO")) salvarNoHistorico();

            const el = document.getElementById(id);
            const txt = encodeURIComponent(el ? el.value : "");

            const phoneRaw = document.getElementById('clientPhone') ? document.getElementById('clientPhone').value : '';
            const digits = (phoneRaw || '').replace(/\D/g, '');

            if (digits.length >= 10) {
                const num = `55${digits}`;
                window.open(`https://wa.me/${num}?text=${txt}`, '_blank');
            } else {
                window.open(`https://wa.me/?text=${txt}`, '_blank');
            }
        }

        function baixarICS() {
            const nome = document.getElementById('clientName').value || "Cliente";
            const carro = document.getElementById('carInfo').value || "Ve√≠culo";
            const dataRaw = document.getElementById('serviceDate').value;
            const hora = document.getElementById('serviceTime').value || "09:00";
            if (!dataRaw) { showToast("Defina data"); return; }

            const start = new Date(`${dataRaw}T${hora}:00`);
            const end = new Date(start.getTime() + 60 * 60 * 1000);

            const fmt = d => d.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';

            const ics = `BEGIN:VCALENDAR
PRODID:-//STAR STUDIO CAR//Agenda//PT-BR
VERSION:2.0
BEGIN:VEVENT
UID:${Date.now()}@starstudiocar
DTSTAMP:${fmt(new Date())}
DTSTART:${fmt(start)}
DTEND:${fmt(end)}
SUMMARY:STAR STUDIO CAR - ${nome}
LOCATION:${MAP_LINK}
DESCRIPTION:Ve√≠culo: ${carro}
END:VEVENT
END:VCALENDAR`;

            const blob = new Blob([ics], { type: 'text/calendar' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `star-${dataRaw}-${hora}.ics`;
            a.click();
            URL.revokeObjectURL(a.href);
        }

        window.onload = initApp;
    </script>
</body>

</html>